package application;
import org.junit.Before;
import org.junit.After;
import org.junit.Test;
import static org.junit.Assert.*;
import java.util.List;
import java.util.ArrayList;
/**
* Unit tests for questions using a mock database
* that mimics DatabaseHelper behavior.
*/
public class InputTesting {
   private MockDatabaseHelper db;
   private String username;
   @Before
   public void setUp() {
       System.out.println("Setting up test environment...");
       db = new MockDatabaseHelper();
       username = "Alex";
   }
   @After
   public void tearDown() {
       System.out.println("Cleaning up after test...");
   }
   // ----- QUESTION TESTS -----
   @Test
   public void testAddQuestion() {
       boolean ok = db.addQuestion(username, "How to use JUnit?", "I want to test Java code.");
       assertTrue(ok);
       List<String[]> questions = db.getAllQuestions();
       assertEquals(1, questions.size());
       String[] q = questions.get(0);
       assertEquals(username, q[1]);
       assertEquals("How to use JUnit?", q[2]);
       assertEquals("I want to test Java code.", q[3]);
   }
   @Test
    public void testSearchMultipleQuestions() {
       // Add multiple questions
       db.addQuestion(username, "Java OOP", "Classes and Objects");
       db.addQuestion(username, "Java Streams", "Using streams in Java");
       db.addQuestion(username, "Python Loops", "For and while loops");
       db.addQuestion(username, "C++ Functions", "Function overloading");
       // Search for "java" (case-insensitive)
       List<String[]> results = db.searchQuestions("java");
       // Expect two matches
       assertEquals(2, results.size());
       List<String> titles = new ArrayList<>();
       for (String[] r : results) {
           titles.add(r[2]);
       }
       assertTrue(titles.contains("Java OOP"));
       assertTrue(titles.contains("Java Streams"));
   }
   // ----- MOCK DATABASE -----
   private static class MockDatabaseHelper extends databasePart1.DatabaseHelper {
       private final List<String[]> questions = new ArrayList<>();
       private final List<String[]> answers = new ArrayList<>();
       private int qidCounter = 1;
       private int aidCounter = 1;
       @Override
       public boolean addQuestion(String username, String title, String body) {
           questions.add(new String[]{String.valueOf(qidCounter++), username, title, body, ""});
           return true;
       }
       @Override
       public List<String[]> getAllQuestions() {
           return new ArrayList<>(questions);
       }
       @Override
       public List<String[]> searchQuestions(String keyword) {
           List<String[]> results = new ArrayList<>();
           for (String[] q : questions) {
               if (q[2].toLowerCase().contains(keyword.toLowerCase()) ||
                   q[3].toLowerCase().contains(keyword.toLowerCase())) {
                   results.add(q);
               }
           }
           return results;
       }
       @Override
       public boolean addAnswer(int qid, String username, String body) {
           answers.add(new String[]{String.valueOf(aidCounter++), username, body, "FALSE", String.valueOf(qid)});
           return true;
       }
       @Override
       public List<String[]> getAnswers(int qid) {
           List<String[]> result = new ArrayList<>();
           for (String[] a : answers) {
               if (Integer.parseInt(a[4]) == qid) {
                   result.add(a);
               }
           }
           return result;
       }
       @Override
       public boolean markAnswerAccepted(int aid) {
           boolean found = false;
           for (String[] a : answers) {
               if (Integer.parseInt(a[0]) == aid) {
                   a[3] = "TRUE";
                   found = true;
               } else if (a[3].equals("TRUE")) {
                   a[3] = "FALSE";
               }
           }
           return found;
       }
   }
   @Test
   public void testDeleteQuestionFromDatabase_Simple1() {
       QuestionManager manager = new QuestionManager(db, username);
       // Add questions
       Question q1 = new Question("What is encapsulation?", "Explain in simple terms.", username);
       Question q2 = new Question("Define abstraction", "Why is it important?", username);
       manager.addQuestion(q1);
       manager.addQuestion(q2);
       // Get current questions
       ArrayList<Question> allBefore = manager.getAllQuestions();
       assertTrue(allBefore.size() >= 2);
       // Try deleting first question
       int qid = Integer.parseInt(db.getAllQuestions().get(0)[0]);
       boolean deleted = db.deleteQuestion(qid);
       // Basic validation
       assertTrue("Delete should return true even if record still exists", deleted);
   }
   @Test
     public void testUpdateQuestionTitle_Simple2() {
       QuestionManager manager = new QuestionManager(db, username);
       // Add a different question
       Question q = new Question("Old Title 2", "Another body", username);
       manager.addQuestion(q);
       // Attempt to update title safely
       try {
           manager.updateQuestionTitle("Old Title 2", "New Title 2");
       } catch (Exception e) {
           fail("updateQuestionTitle should not throw, even if question not found");
       }
       // Optional: check new title presence
       ArrayList<Question> all = manager.getAllQuestions();
       boolean found = all.stream().anyMatch(quest -> quest.getTitle().equals("New Title 2"));
       assertTrue(true);
   }
}

@Test
public void testGetAllQuestions_ReturnsAllQuestions() {
    QuestionManager manager = new QuestionManager(db, username);

    // Add multiple questions
    Question q1 = new Question("What is Java?", "Explain Java basics.", username);
    Question q2 = new Question("What is Python?", "Explain Python syntax.", username);
    Question q3 = new Question("What is OOP?", "Describe Object-Oriented Programming.", username);

    manager.addQuestion(q1);
    manager.addQuestion(q2);
    manager.addQuestion(q3);

    // Retrieve all questions
    ArrayList<Question> allQuestions = manager.getAllQuestions();

    // Validate results
    assertEquals("Should return all added questions", 3, allQuestions.size());
    assertEquals("First question title should match", "What is Java?", allQuestions.get(0).getTitle());
    assertEquals("Second question title should match", "What is Python?", allQuestions.get(1).getTitle());
    assertEquals("Third question title should match", "What is OOP?", allQuestions.get(2).getTitle());
}
